name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.1.0, v1.0.0, etc.
  workflow_dispatch:  # Allow manual trigger from GitHub UI

permissions:
  contents: write  # Required for creating releases

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: npm ci
        env:
          npm_config_canvas_binary_host_mirror: "https://example.invalid/"

      - name: Download Node.js binaries
        run: bash scripts/download-nodejs.sh

      - name: Type check
        run: npm run type-check

      - name: Build application (macOS)
        if: matrix.os == 'macos-latest'
        run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove canvas module (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          if (Test-Path "node_modules/canvas") {
            Remove-Item -Recurse -Force "node_modules/canvas"
            Write-Host "Removed canvas module (not needed in Electron)"
          }
        shell: pwsh

      - name: Build application (Windows)
        if: matrix.os == 'windows-latest'
        run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (macOS Intel)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel
          path: |
            release/**/AiTer-*-mac-x64.dmg
            release/**/AiTer-*-mac-x64.zip
          retention-days: 7

      - name: Upload artifacts (macOS Apple Silicon)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            release/**/AiTer-*-mac-arm64.dmg
            release/**/AiTer-*-mac-arm64.zip
          retention-days: 7

      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            release/**/AiTer-*-win-x64.exe
            release/**/AiTer-*-win-x64.zip
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        env:
          GITHUB_REF: ${{ github.ref }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: AiTer v${{ steps.version.outputs.VERSION }}
          body: |
            # AiTer v${{ steps.version.outputs.VERSION }}

            **PROPRIETARY SOFTWARE - For Authorized Use Only**

            This is a proprietary software release for authorized users only.

            ## ä¸‹è½½è¯´æ˜ / Download Instructions

            ### macOS ç”¨æˆ·
            - **Apple Silicon (M1/M2/M3)**: ä¸‹è½½ `AiTer-*-mac-arm64.dmg`
            - **Intel èŠ¯ç‰‡**: ä¸‹è½½ `AiTer-*-mac-x64.dmg`

            ### Windows ç”¨æˆ·
            - ä¸‹è½½ `AiTer-*-win-x64.exe`

            ## å®‰è£…æ­¥éª¤ / Installation

            ### macOS
            1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ `.dmg` æ–‡ä»¶
            2. åŒå‡»æ‰“å¼€ DMG æ–‡ä»¶
            3. å°† AiTer æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            4. é¦–æ¬¡æ‰“å¼€æ—¶ï¼Œå³é”®ç‚¹å‡» â†’ æ‰“å¼€ï¼ˆç»•è¿‡ Gatekeeperï¼‰

            ### Windows
            1. ä¸‹è½½ `.exe` å®‰è£…ç¨‹åº
            2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
            3. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…

            ## ä¸»è¦åŠŸèƒ½ / Features

            - ğŸ—‚ï¸ å¤šé¡¹ç›®ç®¡ç†
            - ğŸ–¥ï¸ å¤šç»ˆç«¯æ ‡ç­¾æ”¯æŒ
            - ğŸ“ å†…ç½®ä»£ç ç¼–è¾‘å™¨ï¼ˆMonaco Editorï¼‰
            - ğŸŒ HTML å®æ—¶é¢„è§ˆ
            - ğŸ“‹ Markdown é¢„è§ˆ
            - ğŸ”Œ æ’ä»¶ç³»ç»Ÿ
            - âš¡ é«˜æ€§èƒ½ç»ˆç«¯ï¼ˆxterm.jsï¼‰
            - ğŸ¨ ä¼˜é›…çš„æš—è‰²ä¸»é¢˜

            ## ç³»ç»Ÿè¦æ±‚ / Requirements

            - **macOS**: 10.12 (Sierra) or later
            - **Windows**: Windows 10 or later
            - **RAM**: 4GB minimum, 8GB recommended
            - **Disk**: 500MB free space

            ## è®¸å¯åè®® / License

            This software is proprietary. See LICENSE for details.

            **ç‰ˆæƒæ‰€æœ‰ Â© 2025-2026 Within-7.com - ä»»å°å§å‡ºæµ·æˆ˜ç•¥å’¨è¯¢**

            ---

            For internal use only. Do not redistribute.
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
