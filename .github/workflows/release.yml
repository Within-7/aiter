name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.1.0, v1.0.0, etc.
  workflow_dispatch:  # Allow manual trigger from GitHub UI

permissions:
  contents: write  # Required for creating releases

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: npm ci
        env:
          npm_config_canvas_binary_host_mirror: "https://example.invalid/"

      - name: Rebuild native modules for Electron
        run: npx @electron/rebuild
        env:
          npm_config_canvas_binary_host_mirror: "https://example.invalid/"

      - name: Download Node.js binaries
        run: bash scripts/download-nodejs.sh

      - name: Type check
        run: npm run type-check

      - name: Build application (macOS)
        if: matrix.os == 'macos-latest'
        run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove canvas module (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          if (Test-Path "node_modules/canvas") {
            Remove-Item -Recurse -Force "node_modules/canvas"
            Write-Host "Removed canvas module (not needed in Electron)"
          }
        shell: pwsh

      - name: Build application (Windows)
        if: matrix.os == 'windows-latest'
        run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (macOS Intel)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel
          path: |
            release/**/AiTer-*-mac-x64.dmg
            release/**/AiTer-*-mac-x64.dmg.blockmap
            release/**/AiTer-*-mac-x64.zip
            release/**/AiTer-*-mac-x64.zip.blockmap
          retention-days: 7

      - name: Upload artifacts (macOS Apple Silicon)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            release/**/AiTer-*-mac-arm64.dmg
            release/**/AiTer-*-mac-arm64.dmg.blockmap
            release/**/AiTer-*-mac-arm64.zip
            release/**/AiTer-*-mac-arm64.zip.blockmap
          retention-days: 7

      - name: Upload artifacts (macOS Update Manifests)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-manifests
          path: |
            release/**/latest-mac.yml
            release/**/latest.yml
          retention-days: 7

      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            release/**/AiTer-*-win-x64.exe
            release/**/AiTer-*-win-x64.exe.blockmap
            release/**/AiTer-*-win-x64.zip
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        env:
          GITHUB_REF: ${{ github.ref }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: AiTer v${{ steps.version.outputs.VERSION }}
          body: |
            # AiTer v${{ steps.version.outputs.VERSION }}

            AI CLI å·¥å…·åä½œç»ˆç«¯ - AI Terminal Client

            ## ä¸€é”®å®‰è£… / One-Click Installationï¼ˆæ¨è / Recommendedï¼‰

            ä½¿ç”¨è‡ªåŠ¨å®‰è£…è„šæœ¬ï¼Œè‡ªåŠ¨å¤„ç†ç³»ç»Ÿæ£€æµ‹ã€ä¸‹è½½å’Œæƒé™é—®é¢˜ï¼š

            Use the automatic installation script that handles system detection, download, and permissions:

            ### macOS / Linux

            ```bash
            curl -fsSL https://raw.githubusercontent.com/Within-7/AiTer/main/scripts/install.sh | bash
            ```

            è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
            - æ£€æµ‹ç³»ç»Ÿæ¶æ„ï¼ˆApple Silicon æˆ– Intelï¼‰
            - ä¸‹è½½å¯¹åº”ç‰ˆæœ¬
            - è‡ªåŠ¨å®‰è£…åˆ° /Applications
            - å¤„ç† macOS å®‰å…¨é™åˆ¶ï¼ˆç§»é™¤éš”ç¦»å±æ€§ï¼‰

            The script will automatically:
            - Detect system architecture (Apple Silicon or Intel)
            - Download the correct version
            - Install to /Applications
            - Handle macOS security restrictions (remove quarantine attributes)

            ### Windows

            ```powershell
            # ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ PowerShell / Run PowerShell as Administrator
            irm https://raw.githubusercontent.com/Within-7/AiTer/main/scripts/install.ps1 | iex
            ```

            è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
            - ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
            - è‡ªåŠ¨å®‰è£…ï¼ˆå¯é€‰æ‹© GUI æˆ–é™é»˜æ¨¡å¼ï¼‰
            - åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å’Œå¼€å§‹èœå•é¡¹

            The script will automatically:
            - Download the latest version
            - Install automatically (GUI or silent mode)
            - Create desktop shortcut and start menu items

            ---

            ## æ‰‹åŠ¨å®‰è£… / Manual Installation

            ### macOS (Apple Silicon M1/M2/M3)

            ```bash
            # ä¸‹è½½å¹¶å®‰è£… / Download and install
            curl -fsSL https://github.com/Within-7/AiTer/releases/download/v${{ steps.version.outputs.VERSION }}/AiTer-${{ steps.version.outputs.VERSION }}-mac-arm64.dmg -o /tmp/AiTer.dmg
            hdiutil attach /tmp/AiTer.dmg -mountpoint /tmp/AiTer-mount
            cp -R "/tmp/AiTer-mount/AiTer.app" /Applications/
            hdiutil detach /tmp/AiTer-mount
            rm /tmp/AiTer.dmg
            sudo xattr -cr /Applications/AiTer.app
            echo "AiTer å·²å®‰è£…åˆ° /Applications"
            ```

            ### macOS (Intel)

            ```bash
            # ä¸‹è½½å¹¶å®‰è£… / Download and install
            curl -fsSL https://github.com/Within-7/AiTer/releases/download/v${{ steps.version.outputs.VERSION }}/AiTer-${{ steps.version.outputs.VERSION }}-mac-x64.dmg -o /tmp/AiTer.dmg
            hdiutil attach /tmp/AiTer.dmg -mountpoint /tmp/AiTer-mount
            cp -R "/tmp/AiTer-mount/AiTer.app" /Applications/
            hdiutil detach /tmp/AiTer-mount
            rm /tmp/AiTer.dmg
            sudo xattr -cr /Applications/AiTer.app
            echo "AiTer å·²å®‰è£…åˆ° /Applications"
            ```

            ### Windows (PowerShell)

            ```powershell
            # ä¸‹è½½å¹¶å®‰è£… / Download and install
            $url = "https://github.com/Within-7/AiTer/releases/download/v${{ steps.version.outputs.VERSION }}/AiTer-${{ steps.version.outputs.VERSION }}-win-x64.exe"
            $installer = "$env:TEMP\AiTer-Setup.exe"
            Invoke-WebRequest -Uri $url -OutFile $installer
            Start-Process -FilePath $installer -Wait
            Remove-Item $installer
            Write-Host "AiTer å®‰è£…å®Œæˆ"
            ```

            ### Windows (é™é»˜å®‰è£… / Silent Install)

            ```powershell
            # é™é»˜å®‰è£…ï¼ˆæ—  UIï¼‰/ Silent install (no UI)
            $url = "https://github.com/Within-7/AiTer/releases/download/v${{ steps.version.outputs.VERSION }}/AiTer-${{ steps.version.outputs.VERSION }}-win-x64.exe"
            $installer = "$env:TEMP\AiTer-Setup.exe"
            Invoke-WebRequest -Uri $url -OutFile $installer
            Start-Process -FilePath $installer -ArgumentList "/S" -Wait
            Remove-Item $installer
            Write-Host "AiTer é™é»˜å®‰è£…å®Œæˆ"
            ```

            ---

            ## æ‰‹åŠ¨ä¸‹è½½ / Manual Download

            | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
            |------|------|------|
            | macOS | Apple Silicon (M1/M2/M3) | `AiTer-${{ steps.version.outputs.VERSION }}-mac-arm64.dmg` |
            | macOS | Intel | `AiTer-${{ steps.version.outputs.VERSION }}-mac-x64.dmg` |
            | Windows | x64 | `AiTer-${{ steps.version.outputs.VERSION }}-win-x64.exe` |

            ---

            ## ä¸»è¦åŠŸèƒ½ / Features

            - ğŸ—‚ï¸ å¤šé¡¹ç›®ç®¡ç†
            - ğŸ–¥ï¸ å¤šç»ˆç«¯æ ‡ç­¾æ”¯æŒ
            - ğŸ“ å†…ç½®ä»£ç ç¼–è¾‘å™¨ï¼ˆMonaco Editorï¼‰
            - ğŸŒ HTML å®æ—¶é¢„è§ˆ
            - ğŸ“‹ Markdown é¢„è§ˆ
            - ğŸ”Œ æ’ä»¶ç³»ç»Ÿ
            - âš¡ é«˜æ€§èƒ½ç»ˆç«¯ï¼ˆxterm.jsï¼‰
            - ğŸ”„ è‡ªåŠ¨æ›´æ–°

            ## ç³»ç»Ÿè¦æ±‚ / Requirements

            - **macOS**: 10.12 (Sierra) æˆ–æ›´é«˜ç‰ˆæœ¬
            - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
            - **RAM**: æœ€ä½ 4GBï¼Œæ¨è 8GB
            - **ç£ç›˜**: 500MB å¯ç”¨ç©ºé—´

            ---

            **ç‰ˆæƒæ‰€æœ‰ Â© 2025-2026 Within-7.com**
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.zip
            artifacts/**/*.blockmap
            artifacts/**/*.yml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
