# AiTer è¯­éŸ³è¾“å…¥åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## æ¦‚è¿°

ä¸º AiTer æ·»åŠ ç°ä»£åŒ–çš„è¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥é€šè¿‡è¯­éŸ³ä¸ AI CLI å·¥å…·å’Œæ–‡ä»¶ç¼–è¾‘å™¨è¿›è¡Œäº¤äº’ã€‚

## è®¾è®¡ç›®æ ‡

1. **æ— ç¼é›†æˆ** - è¯­éŸ³è¾“å…¥ä½œä¸ºç°æœ‰è¾“å…¥æ–¹å¼çš„è¡¥å……ï¼Œä¸æ”¹å˜ç”¨æˆ·ä¹ æƒ¯
2. **å¤šåœºæ™¯æ”¯æŒ** - åŒæ—¶æ”¯æŒç»ˆç«¯å‘½ä»¤è¾“å…¥ã€ä»£ç ç¼–è¾‘ã€æ–‡æ¡£æ’°å†™
3. **æ™ºèƒ½é€‚é…** - æ ¹æ®ä¸Šä¸‹æ–‡æ™ºèƒ½è°ƒæ•´è¯­éŸ³è¯†åˆ«è¡Œä¸º
4. **ä½å»¶è¿Ÿ** - å®æ—¶åé¦ˆï¼Œæµå¼æ˜¾ç¤ºè¯†åˆ«ç»“æœ
5. **éšç§ä¼˜å…ˆ** - æ”¯æŒæœ¬åœ°è¯†åˆ«ï¼Œç”¨æˆ·å¯æ§æ•°æ®æµå‘

---

## äº¤äº’è®¾è®¡

### 1. æ¿€æ´»æ–¹å¼

#### 1.1 æŒ‰ä½è¯´è¯ (Push-to-Talk) - æ¨èæ–¹å¼

```
é»˜è®¤æŒ‰é”®: Option (macOS) / Alt (Windows)
```

**äº¤äº’æµç¨‹ï¼š**
```
æŒ‰ä¸‹ Option â”€â”€â†’ å¼€å§‹å½•éŸ³ â”€â”€â†’ è¯´è¯ â”€â”€â†’ æ¾å¼€ Option â”€â”€â†’ ç»“æŸå½•éŸ³ â”€â”€â†’ è¯†åˆ«å¹¶è¾“å…¥
     â”‚                                      â”‚
     â””â”€â”€ æ˜¾ç¤ºå½•éŸ³æŒ‡ç¤ºå™¨                      â””â”€â”€ éšè—æŒ‡ç¤ºå™¨ï¼Œæ’å…¥æ–‡æœ¬
```

**ä¸ºä»€ä¹ˆé€‰æ‹© Option/Alt é”®ï¼Ÿ**
- âœ… å•é”®æ“ä½œï¼Œæ¯”ç»„åˆé”®æ›´è‡ªç„¶
- âœ… ä½ç½®é€‚åˆæ‹‡æŒ‡æŒ‰å‹ï¼Œç¬¦åˆäººä½“å·¥å­¦
- âœ… åœ¨ç»ˆç«¯å’Œç¼–è¾‘å™¨ä¸­å¾ˆå°‘å•ç‹¬ä½¿ç”¨
- âœ… ç±»ä¼¼å¯¹è®²æœºçš„ç›´è§‰æ“ä½œ

**é˜²è¯¯è§¦æœºåˆ¶ï¼š**
- éœ€æŒ‰ä½è¶…è¿‡ 200ms æ‰å¼€å§‹å½•éŸ³ï¼ˆé¿å…è¯¯è§¦ï¼‰
- æŒ‰ä½æ—¶é—´å°‘äº 500ms ä¸”æ— è¯­éŸ³æ£€æµ‹æ—¶ï¼Œä¸è§¦å‘è¯†åˆ«
- å¦‚æœç„¦ç‚¹åœ¨éœ€è¦ Option çš„è¾“å…¥æ¡†ä¸­ï¼Œè‡ªåŠ¨ç¦ç”¨

**å¯é€‰æ›¿ä»£é”®ï¼š**
| æŒ‰é”® | macOS | Windows | è¯´æ˜ |
|------|-------|---------|------|
| Option/Alt | âŒ¥ | Alt | é»˜è®¤æ¨è |
| Fn | Fn | Fn | æ›´ä¸å®¹æ˜“è¯¯è§¦ |
| å³ Command | âŒ˜ (å³) | å³ Ctrl | é€‚åˆå³æ‰‹æ“ä½œ |
| è‡ªå®šä¹‰ | ç”¨æˆ·è®¾ç½® | ç”¨æˆ·è®¾ç½® | ä»»æ„å•é”®æˆ–ç»„åˆé”® |

#### 1.2 åˆ‡æ¢æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

```
å¿«æ·é”®: Cmd+Shift+V (macOS) / Ctrl+Shift+V (Windows)
```

- æŒ‰ä¸€æ¬¡å¼€å§‹å½•éŸ³
- å†æŒ‰ä¸€æ¬¡ç»“æŸå½•éŸ³
- é€‚åˆé•¿æ—¶é—´è¯­éŸ³è¾“å…¥åœºæ™¯

#### 1.3 UI æŒ‰é’®æ¿€æ´»ï¼ˆè¾…åŠ©æ–¹å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Tab1] [Tab2] [Tab3]              [ğŸ¤]  [âš™ï¸]        â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                     â”‚
â”‚  Terminal / Editor Content                          â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- æ ‡ç­¾æ å³ä¾§æ·»åŠ éº¦å…‹é£æŒ‰é’®
- ç‚¹å‡»æ¿€æ´»/åœæ­¢è¯­éŸ³è¾“å…¥
- å½•éŸ³æ—¶æŒ‰é’®æ˜¾ç¤ºåŠ¨ç”»æ•ˆæœ

#### 1.3 è¯­éŸ³å”¤é†’ï¼ˆå¯é€‰é«˜çº§åŠŸèƒ½ï¼‰

```
å”¤é†’è¯: "Hey AiTer" æˆ–è‡ªå®šä¹‰
```

- éœ€è¦åå°ç›‘å¬ï¼ŒåŠŸè€—è¾ƒé«˜
- ä½œä¸ºå¯é€‰çš„é«˜çº§åŠŸèƒ½
- é»˜è®¤å…³é—­

### 2. è§†è§‰åé¦ˆ

#### 2.1 å½•éŸ³çŠ¶æ€æŒ‡ç¤ºå™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  ğŸ”´ æ­£åœ¨å½•éŸ³...  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  [åœæ­¢]         â”‚   â”‚
â”‚ â”‚  "æˆ‘æƒ³è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ React ç»„ä»¶..."           â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  $ npm run dev                                      â”‚
â”‚  > vite                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€æŒ‡ç¤ºå™¨ç‰¹æ€§ï¼š**
- æµ®åŠ¨åœ¨å½“å‰æ´»åŠ¨åŒºåŸŸä¸Šæ–¹
- æ˜¾ç¤ºå½•éŸ³æ³¢å½¢/éŸ³é‡æ¡
- å®æ—¶æ˜¾ç¤ºè¯†åˆ«ä¸­çš„æ–‡å­—ï¼ˆæµå¼ï¼‰
- æä¾›æ‰‹åŠ¨åœæ­¢æŒ‰é’®

#### 2.2 çŠ¶æ€å›¾æ ‡å˜åŒ–

| çŠ¶æ€ | å›¾æ ‡ | é¢œè‰² | æè¿° |
|------|------|------|------|
| å¾…æœº | ğŸ¤ | ç°è‰² | å¯ä»¥å¼€å§‹å½•éŸ³ |
| å½•éŸ³ä¸­ | ğŸ”´ | çº¢è‰²+è„‰åŠ¨åŠ¨ç”» | æ­£åœ¨å½•éŸ³ |
| å¤„ç†ä¸­ | â³ | é»„è‰² | æ­£åœ¨è¯†åˆ« |
| é”™è¯¯ | âš ï¸ | çº¢è‰² | è¯†åˆ«å¤±è´¥ |

### 3. æ–‡æœ¬æ’å…¥è¡Œä¸º

#### 3.1 ç»ˆç«¯æ¨¡å¼

```typescript
// è¯­éŸ³è¯†åˆ«å®Œæˆå
const insertToTerminal = (text: string, options: InsertOptions) => {
  // ä¸è‡ªåŠ¨æ‰§è¡Œï¼Œåªè¾“å…¥æ–‡æœ¬
  await window.api.terminal.write(activeTerminalId, text)

  // ç”¨æˆ·å¯é€‰ï¼šè‡ªåŠ¨æ·»åŠ æ¢è¡Œæ‰§è¡Œ
  if (options.autoExecute) {
    await window.api.terminal.write(activeTerminalId, '\n')
  }
}
```

**ç»ˆç«¯ä¸“ç”¨æŒ‡ä»¤è¯†åˆ«ï¼š**
- "æ‰§è¡Œ" / "è¿è¡Œ" / "å›è½¦" â†’ å‘é€æ¢è¡Œç¬¦
- "æ¸…ç©º" / "æ¸…é™¤" â†’ å‘é€ Ctrl+C æˆ–æ¸…ç©ºè¾“å…¥
- "ä¸Šä¸€æ¡" / "ä¸Šä¸€ä¸ªå‘½ä»¤" â†’ å‘é€å‘ä¸Šç®­å¤´

#### 3.2 ç¼–è¾‘å™¨æ¨¡å¼

```typescript
// è¯­éŸ³è¯†åˆ«å®Œæˆå
const insertToEditor = (text: string, options: InsertOptions) => {
  // è·å–å½“å‰å…‰æ ‡ä½ç½®
  const position = editor.getPosition()

  // æ’å…¥æ–‡æœ¬
  editor.executeEdits('voice-input', [{
    range: new Range(position.lineNumber, position.column, position.lineNumber, position.column),
    text: text
  }])
}
```

**ç¼–è¾‘å™¨ä¸“ç”¨æŒ‡ä»¤è¯†åˆ«ï¼š**
- "æ–°è¡Œ" / "æ¢è¡Œ" â†’ æ’å…¥æ¢è¡Œç¬¦
- "åˆ é™¤è¿™è¡Œ" â†’ åˆ é™¤å½“å‰è¡Œ
- "æ’¤é”€" â†’ è§¦å‘ Ctrl+Z

### 4. æ™ºèƒ½ä¸Šä¸‹æ–‡é€‚é…

#### 4.1 è¯­è¨€æ£€æµ‹
```typescript
interface VoiceContext {
  activeArea: 'terminal' | 'editor' | 'search'
  fileType?: string      // 'typescript', 'python', 'markdown'
  projectType?: string   // ä» package.json æˆ–å…¶ä»–é…ç½®æ¨æ–­
  recentCommands?: string[] // æœ€è¿‘ä½¿ç”¨çš„å‘½ä»¤
}
```

#### 4.2 æœ¯è¯­è¡¨æ”¯æŒ
```typescript
// ç”¨æˆ·å¯è‡ªå®šä¹‰æœ¯è¯­è¡¨
const customVocabulary = {
  // å¸¸è§ç¼–ç¨‹æœ¯è¯­
  "function": ["å‡½æ•°", "æ–¹æ³•"],
  "const": ["å¸¸é‡", "åº·æ–¯ç‰¹"],
  "npm": ["æ©çš®æ©", "NPM"],

  // é¡¹ç›®ç‰¹å®šæœ¯è¯­
  "AiTer": ["çˆ±ç‰¹", "è‰¾ç‰¹"],
  "xterm": ["è‰¾å…‹æ–¯ç‰¹å§†", "X term"]
}
```

---

## æŠ€æœ¯æ¶æ„

### 1. è¯­éŸ³è¯†åˆ«åç«¯é€‰æ‹©

#### æ–¹æ¡ˆ A: Web Speech APIï¼ˆæ¨èé»˜è®¤æ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹ï¼š**
- æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–ä¾èµ–
- Electron åŸºäº Chromiumï¼Œå®Œå…¨æ”¯æŒ
- å…è´¹ä½¿ç”¨ï¼Œæ—  API è´¹ç”¨
- å»¶è¿Ÿä½ï¼ˆæµå¼è¯†åˆ«ï¼‰

**ç¼ºç‚¹ï¼š**
- éœ€è¦ç½‘ç»œè¿æ¥ï¼ˆChrome ä½¿ç”¨ Google æœåŠ¡å™¨ï¼‰
- è¯†åˆ«å‡†ç¡®åº¦ä¾èµ– Google
- ä¸­æ–‡æ”¯æŒè‰¯å¥½ä½†æŠ€æœ¯æœ¯è¯­å¯èƒ½ä¸å‡†

**å®ç°ï¼š**
```typescript
// src/renderer/services/WebSpeechRecognition.ts
export class WebSpeechRecognition implements VoiceRecognitionService {
  private recognition: SpeechRecognition

  constructor(options: RecognitionOptions) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition
    this.recognition = new SpeechRecognition()
    this.recognition.continuous = options.continuous
    this.recognition.interimResults = true
    this.recognition.lang = options.language // 'zh-CN', 'en-US'
  }

  start(): void {
    this.recognition.start()
  }

  stop(): void {
    this.recognition.stop()
  }

  onResult(callback: (result: RecognitionResult) => void): void {
    this.recognition.onresult = (event) => {
      const result = event.results[event.resultIndex]
      callback({
        text: result[0].transcript,
        isFinal: result.isFinal,
        confidence: result[0].confidence
      })
    }
  }
}
```

#### æ–¹æ¡ˆ B: OpenAI Whisper APIï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹ï¼š**
- æé«˜çš„è¯†åˆ«å‡†ç¡®åº¦
- ä¼˜ç§€çš„å¤šè¯­è¨€æ”¯æŒ
- æ“…é•¿æŠ€æœ¯æœ¯è¯­

**ç¼ºç‚¹ï¼š**
- éœ€è¦ä»˜è´¹ API
- éœ€è¦å½•åˆ¶å®Œæ•´éŸ³é¢‘åä¸Šä¼ ï¼ˆéæµå¼ï¼‰
- æœ‰ä¸€å®šå»¶è¿Ÿ

**å®ç°ï¼š**
```typescript
// src/main/services/WhisperService.ts
export class WhisperService {
  private apiKey: string

  async transcribe(audioBuffer: Buffer): Promise<string> {
    const formData = new FormData()
    formData.append('file', new Blob([audioBuffer]), 'audio.webm')
    formData.append('model', 'whisper-1')
    formData.append('language', 'zh')

    const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${this.apiKey}` },
      body: formData
    })

    const data = await response.json()
    return data.text
  }
}
```

#### æ–¹æ¡ˆ C: æœ¬åœ° Whisperï¼ˆéšç§ä¼˜å…ˆæ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹ï¼š**
- å®Œå…¨ç¦»çº¿ï¼Œä¿æŠ¤éšç§
- æ—  API è´¹ç”¨

**ç¼ºç‚¹ï¼š**
- éœ€è¦ä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼ˆ~1GBï¼‰
- éœ€è¦è¾ƒå¥½çš„ç¡¬ä»¶
- å®ç°å¤æ‚åº¦é«˜

**å®ç°æ€è·¯ï¼š**
- ä½¿ç”¨ whisper.cpp æˆ– whisper-node
- æ‰“åŒ…æ—¶ä¸å«æ¨¡å‹ï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶ä¸‹è½½
- æä¾› tiny/base/small ç­‰æ¨¡å‹é€‰æ‹©

### 2. æ¨èçš„æ··åˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VoiceInputManager                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  ç»Ÿä¸€æ¥å£å±‚                          â”‚    â”‚
â”‚  â”‚  start() | stop() | onResult() | onError()          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â”‚                                  â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚           â–¼               â–¼               â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Web Speech  â”‚  â”‚  Whisper    â”‚  â”‚   Local     â”‚          â”‚
â”‚  â”‚    API      â”‚  â”‚    API      â”‚  â”‚   Whisper   â”‚          â”‚
â”‚  â”‚  (é»˜è®¤)     â”‚  â”‚  (é«˜ç²¾åº¦)   â”‚  â”‚  (ç¦»çº¿)     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ•°æ®æµ

```
ç”¨æˆ·è¯´è¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éº¦å…‹é£é‡‡é›†  â”‚  (Renderer Process - MediaDevices API)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯­éŸ³è¯†åˆ«   â”‚  (Web Speech API / Whisper)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–‡æœ¬åå¤„ç†  â”‚  (æ ‡ç‚¹ã€æ ¼å¼åŒ–ã€æŒ‡ä»¤è§£æ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Terminalâ”‚      â”‚ Editor  â”‚      â”‚ Search  â”‚
â”‚  Input  â”‚      â”‚  Input  â”‚      â”‚  Input  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ ipc/
â”‚   â”‚   â””â”€â”€ voiceInput.ts          # IPC å¤„ç†ï¼ˆéŸ³é¢‘æƒé™ã€Whisper APIï¼‰
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ WhisperService.ts      # Whisper API é›†æˆ
â”‚
â”œâ”€â”€ renderer/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ VoiceInputManager.ts   # è¯­éŸ³è¾“å…¥ç»Ÿä¸€ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ WebSpeechRecognition.ts # Web Speech API å®ç°
â”‚   â”‚   â””â”€â”€ WhisperRecognition.ts  # Whisper å®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ VoiceInput/
â”‚   â”‚   â”‚   â”œâ”€â”€ VoiceInputButton.tsx    # éº¦å…‹é£æŒ‰é’®
â”‚   â”‚   â”‚   â”œâ”€â”€ VoiceInputIndicator.tsx # å½•éŸ³çŠ¶æ€æŒ‡ç¤ºå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ VoiceInputOverlay.tsx   # æµ®åŠ¨å½•éŸ³é¢æ¿
â”‚   â”‚   â”‚   â””â”€â”€ VoiceWaveform.tsx       # éŸ³é‡æ³¢å½¢æ˜¾ç¤º
â”‚   â”‚   â””â”€â”€ Settings/
â”‚   â”‚       â””â”€â”€ VoiceInputSettings.tsx  # è¯­éŸ³è®¾ç½®é¢æ¿
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useVoiceInput.ts       # è¯­éŸ³è¾“å…¥ React Hook
â”‚   â”‚
â”‚   â””â”€â”€ context/
â”‚       â””â”€â”€ VoiceInputContext.tsx  # è¯­éŸ³è¾“å…¥çŠ¶æ€ç®¡ç†
â”‚
â””â”€â”€ types/
    â””â”€â”€ voiceInput.ts              # TypeScript ç±»å‹å®šä¹‰
```

---

## è®¾ç½®é¡¹

```typescript
interface VoiceInputSettings {
  // åŸºç¡€è®¾ç½®
  enabled: boolean                    // æ˜¯å¦å¯ç”¨è¯­éŸ³è¾“å…¥
  provider: 'web-speech' | 'whisper-api' | 'whisper-local'

  // Push-to-Talk è®¾ç½®
  pushToTalk: {
    enabled: boolean                  // å¯ç”¨æŒ‰ä½è¯´è¯
    triggerKey: 'Alt' | 'Meta' | 'Control' | 'Fn' | string  // è§¦å‘é”®
    minHoldDuration: number           // æœ€å°æŒ‰ä½æ—¶é—´ï¼ˆmsï¼‰ï¼Œé»˜è®¤ 200
  }

  // åˆ‡æ¢æ¨¡å¼è®¾ç½®ï¼ˆå¤‡é€‰ï¼‰
  toggleMode: {
    enabled: boolean                  // å¯ç”¨åˆ‡æ¢æ¨¡å¼
    shortcut: KeyboardShortcut        // Cmd+Shift+V
  }

  // è¯†åˆ«è®¾ç½®
  language: string                    // 'zh-CN', 'en-US', 'auto'
  continuous: boolean                 // è¿ç»­è¯†åˆ«æ¨¡å¼
  interimResults: boolean             // æ˜¾ç¤ºä¸­é—´ç»“æœï¼ˆæµå¼ï¼‰

  // è¡Œä¸ºè®¾ç½®
  autoExecuteInTerminal: boolean      // ç»ˆç«¯ä¸­è‡ªåŠ¨æ‰§è¡Œï¼ˆæŒ‰å›è½¦ï¼‰
  insertMode: 'cursor' | 'newline'    // æ’å…¥ä½ç½®
  enableVoiceCommands: boolean        // å¯ç”¨è¯­éŸ³æŒ‡ä»¤ï¼ˆ"æ‰§è¡Œ"ã€"æ¢è¡Œ"ç­‰ï¼‰

  // API è®¾ç½®ï¼ˆä»… Whisperï¼‰
  whisperApiKey?: string
  whisperModel?: 'whisper-1'

  // é«˜çº§è®¾ç½®
  customVocabulary?: Record<string, string[]>  // è‡ªå®šä¹‰æœ¯è¯­
  noiseReduction: boolean             // é™å™ª
  silenceTimeout: number              // é™éŸ³è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
}
```

**è®¾ç½® UI å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯­éŸ³è¾“å…¥è®¾ç½®                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚ å¯ç”¨è¯­éŸ³è¾“å…¥              [å¼€å…³]                    â”‚
â”‚                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                     â”‚
â”‚ è¯†åˆ«å¼•æ“                                            â”‚
â”‚ â—‹ Web Speech API (å…è´¹ï¼Œéœ€è¦ç½‘ç»œ)                   â”‚
â”‚ â—‹ OpenAI Whisper API (é«˜ç²¾åº¦ï¼Œéœ€è¦ API Key)         â”‚
â”‚ â—‹ æœ¬åœ° Whisper (ç¦»çº¿ï¼Œéœ€è¦ä¸‹è½½æ¨¡å‹)                 â”‚
â”‚                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                     â”‚
â”‚ æ¿€æ´»æ–¹å¼                                            â”‚
â”‚                                                     â”‚
â”‚ â˜‘ æŒ‰ä½è¯´è¯ (Push-to-Talk)                          â”‚
â”‚   è§¦å‘é”®                   [Option/Alt     â–¼]       â”‚
â”‚   æœ€å°æŒ‰ä½æ—¶é—´             [200ms          â–¼]       â”‚
â”‚                                                     â”‚
â”‚ â–¡ åˆ‡æ¢æ¨¡å¼                                          â”‚
â”‚   å¿«æ·é”®                   [Cmd+Shift+V] [ä¿®æ”¹]     â”‚
â”‚                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                     â”‚
â”‚ è¯†åˆ«è¯­è¨€                   [ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰    â–¼]      â”‚
â”‚                                                     â”‚
â”‚ â–¡ åœ¨ç»ˆç«¯ä¸­è‡ªåŠ¨æ‰§è¡Œå‘½ä»¤                              â”‚
â”‚ â˜‘ æ˜¾ç¤ºå®æ—¶è¯†åˆ«ç»“æœ                                  â”‚
â”‚ â˜‘ å¯ç”¨è¯­éŸ³æŒ‡ä»¤ï¼ˆå¦‚"æ‰§è¡Œ"ã€"æ¢è¡Œ"ï¼‰                 â”‚
â”‚                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                     â”‚
â”‚ æç¤ºï¼šæŒ‰ä½ Option é”®è¯´è¯ï¼Œæ¾å¼€åè‡ªåŠ¨è¾“å…¥æ–‡å­—        â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®ç°é˜¶æ®µ

### Phase 1: åŸºç¡€åŠŸèƒ½ï¼ˆMVPï¼‰
- [x] Web Speech API é›†æˆ
- [x] å¿«æ·é”®æ¿€æ´»
- [x] ç»ˆç«¯æ–‡æœ¬è¾“å…¥
- [x] åŸºç¡€ UI æŒ‡ç¤ºå™¨
- [x] è®¾ç½®é¢æ¿

### Phase 2: å¢å¼ºä½“éªŒ
- [ ] ç¼–è¾‘å™¨é›†æˆ
- [ ] æµå¼æ˜¾ç¤ºè¯†åˆ«ç»“æœ
- [ ] è¯­éŸ³æŒ‡ä»¤æ”¯æŒ
- [ ] å¤šè¯­è¨€åˆ‡æ¢

### Phase 3: é«˜çº§åŠŸèƒ½
- [ ] Whisper API é›†æˆ
- [ ] è‡ªå®šä¹‰æœ¯è¯­è¡¨
- [ ] æ™ºèƒ½ä¸Šä¸‹æ–‡é€‚é…
- [ ] æœ¬åœ° Whisper æ”¯æŒ

### Phase 4: å®Œå–„ä¼˜åŒ–
- [ ] è¯­éŸ³å”¤é†’
- [ ] éŸ³é¢‘é™å™ª
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] å®Œæ•´æµ‹è¯•

---

## æŠ€æœ¯ç»†èŠ‚

### 1. Push-to-Talk æŒ‰é”®ç›‘å¬å®ç°

```typescript
// src/renderer/hooks/usePushToTalk.ts
import { useEffect, useRef, useCallback } from 'react'

interface PushToTalkOptions {
  triggerKey: string           // 'Alt', 'Meta', 'Fn' ç­‰
  minHoldDuration: number      // æœ€å°æŒ‰ä½æ—¶é—´ï¼ˆmsï¼‰ï¼Œé˜²è¯¯è§¦
  onStart: () => void          // å¼€å§‹å½•éŸ³å›è°ƒ
  onEnd: () => void            // ç»“æŸå½•éŸ³å›è°ƒ
  enabled: boolean             // æ˜¯å¦å¯ç”¨
}

export function usePushToTalk(options: PushToTalkOptions) {
  const {
    triggerKey = 'Alt',
    minHoldDuration = 200,
    onStart,
    onEnd,
    enabled = true
  } = options

  const isHolding = useRef(false)
  const holdStartTime = useRef<number | null>(null)
  const isRecording = useRef(false)

  const handleKeyDown = useCallback((event: KeyboardEvent) => {
    if (!enabled) return

    // æ£€æŸ¥æ˜¯å¦æ˜¯è§¦å‘é”®
    const isTriggerKey =
      (triggerKey === 'Alt' && event.altKey && event.key === 'Alt') ||
      (triggerKey === 'Meta' && event.metaKey && event.key === 'Meta') ||
      (triggerKey === 'Control' && event.ctrlKey && event.key === 'Control')

    if (!isTriggerKey) return

    // é˜²æ­¢é‡å¤è§¦å‘
    if (isHolding.current) return

    isHolding.current = true
    holdStartTime.current = Date.now()

    // å»¶è¿Ÿå¯åŠ¨å½•éŸ³ï¼ˆé˜²è¯¯è§¦ï¼‰
    setTimeout(() => {
      if (isHolding.current && !isRecording.current) {
        isRecording.current = true
        onStart()
      }
    }, minHoldDuration)

  }, [triggerKey, minHoldDuration, onStart, enabled])

  const handleKeyUp = useCallback((event: KeyboardEvent) => {
    if (!enabled) return

    const isTriggerKey =
      (triggerKey === 'Alt' && event.key === 'Alt') ||
      (triggerKey === 'Meta' && event.key === 'Meta') ||
      (triggerKey === 'Control' && event.key === 'Control')

    if (!isTriggerKey) return

    const holdDuration = holdStartTime.current
      ? Date.now() - holdStartTime.current
      : 0

    isHolding.current = false
    holdStartTime.current = null

    // åªæœ‰åœ¨å®é™…å½•éŸ³çŠ¶æ€æ—¶æ‰è§¦å‘ç»“æŸ
    if (isRecording.current) {
      isRecording.current = false
      onEnd()
    }

  }, [triggerKey, onEnd, enabled])

  useEffect(() => {
    if (!enabled) return

    window.addEventListener('keydown', handleKeyDown)
    window.addEventListener('keyup', handleKeyUp)

    // å¤„ç†çª—å£å¤±ç„¦æ—¶çš„æƒ…å†µï¼ˆç”¨æˆ·æŒ‰ä½é”®åˆ‡æ¢çª—å£ï¼‰
    const handleBlur = () => {
      if (isRecording.current) {
        isRecording.current = false
        isHolding.current = false
        onEnd()
      }
    }
    window.addEventListener('blur', handleBlur)

    return () => {
      window.removeEventListener('keydown', handleKeyDown)
      window.removeEventListener('keyup', handleKeyUp)
      window.removeEventListener('blur', handleBlur)
    }
  }, [handleKeyDown, handleKeyUp, onEnd, enabled])
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
usePushToTalk({
  triggerKey: 'Alt',
  minHoldDuration: 200,
  onStart: () => {
    voiceInputManager.startRecording()
    setShowIndicator(true)
  },
  onEnd: () => {
    voiceInputManager.stopRecording()
    setShowIndicator(false)
  },
  enabled: settings.voiceInput?.enabled ?? false
})
```

### 2. éº¦å…‹é£æƒé™å¤„ç†

```typescript
// src/renderer/services/VoiceInputManager.ts
async requestMicrophonePermission(): Promise<boolean> {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
    stream.getTracks().forEach(track => track.stop())
    return true
  } catch (error) {
    if (error.name === 'NotAllowedError') {
      // ç”¨æˆ·æ‹’ç»äº†æƒé™
      this.showPermissionDeniedDialog()
    }
    return false
  }
}
```

### 3. éŸ³é¢‘å¯è§†åŒ–

```typescript
// src/renderer/components/VoiceInput/VoiceWaveform.tsx
const VoiceWaveform: React.FC<{ stream: MediaStream }> = ({ stream }) => {
  const canvasRef = useRef<HTMLCanvasElement>(null)

  useEffect(() => {
    const audioContext = new AudioContext()
    const analyser = audioContext.createAnalyser()
    const source = audioContext.createMediaStreamSource(stream)
    source.connect(analyser)

    const dataArray = new Uint8Array(analyser.frequencyBinCount)

    const draw = () => {
      analyser.getByteFrequencyData(dataArray)
      // ç»˜åˆ¶æ³¢å½¢...
      requestAnimationFrame(draw)
    }

    draw()
  }, [stream])

  return <canvas ref={canvasRef} />
}
```

### 4. ç„¦ç‚¹ç®¡ç†

```typescript
// ç¡®å®šå½“å‰æ´»åŠ¨è¾“å…¥åŒºåŸŸ
const getActiveInputTarget = (): 'terminal' | 'editor' | 'search' | null => {
  const activeElement = document.activeElement

  if (activeElement?.closest('.xterm')) {
    return 'terminal'
  }
  if (activeElement?.closest('.monaco-editor')) {
    return 'editor'
  }
  if (activeElement?.closest('.search-input')) {
    return 'search'
  }

  // å›é€€ï¼šæ£€æŸ¥å“ªä¸ªåŒºåŸŸå¯è§
  if (state.activeTerminalId) return 'terminal'
  if (state.activeEditorTabId) return 'editor'

  return null
}
```

---

## å®‰å…¨ä¸éšç§

1. **éº¦å…‹é£æƒé™**
   - é¦–æ¬¡ä½¿ç”¨æ—¶è¯·æ±‚æƒé™
   - æƒé™è¢«æ‹’ç»æ—¶æä¾›æ¸…æ™°çš„è¯´æ˜
   - åœ¨è®¾ç½®ä¸­æä¾›æƒé™çŠ¶æ€æŒ‡ç¤º

2. **æ•°æ®ä¼ è¾“**
   - Web Speech API: éŸ³é¢‘å‘é€åˆ° Google æœåŠ¡å™¨
   - Whisper API: éŸ³é¢‘å‘é€åˆ° OpenAI æœåŠ¡å™¨
   - æœ¬åœ° Whisper: å®Œå…¨ç¦»çº¿å¤„ç†

3. **API Key å®‰å…¨**
   - Whisper API Key å­˜å‚¨åœ¨ electron-store ä¸­ï¼ˆåŠ å¯†ï¼‰
   - ä¸åœ¨æ—¥å¿—ä¸­è¾“å‡º API Key
   - æä¾› API Key éªŒè¯åŠŸèƒ½

4. **ç”¨æˆ·çŸ¥æƒ…æƒ**
   - æ˜ç¡®è¯´æ˜å„æ–¹æ¡ˆçš„æ•°æ®æµå‘
   - åœ¨ä½¿ç”¨äº‘æœåŠ¡æ—¶æ˜¾ç¤ºæç¤º
   - æä¾›éšç§æ”¿ç­–é“¾æ¥

---

## å‚è€ƒèµ„æº

- [Web Speech API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API)
- [OpenAI Whisper](https://openai.com/index/whisper/)
- [Best Speech-to-Text APIs 2025](https://deepgram.com/learn/best-speech-to-text-apis)
- [JavaScript Speech Recognition Guide](https://www.videosdk.live/developer-hub/stt/javascript-speech-recognition)
